# Прерывания  
**Прерывание** - событие, которое заставляет процессор прервать текущую задачу и вызвать специальный обработчик.  
Прерывания могут происходить асинхронно, то есть код не может сохранить свое состояние, чтобы после обработки прерыаания продолжить исполняться. 
Поэтому именно обработчик должен быть ответственен за сохранение состояния прерванной задачи.  
***Откуда берутся обработчики прерыания (далее ОП)?***  
ОП - часть ядра ОС и похожи на обычные функции. В момент загрузки, когда ОС загружается, инициализирует процессор и устройства, она сообщает процу, где лежат ОП и 
каким событиям какой обработчик соответствует.  
## Вызов ОП  
Процессор должен сохранять информацию о том, куда вернуть управление. Есть 2 варианта информации, сохраненной на стеке при вызове ОП:
![Снимок экрана (354)](https://github.com/BorisDeLaMar/Operating_systems/assets/91004615/a37caae8-d929-4287-8c66-8ac16d0a3e00)  
Напоммним:  
* RIP - адрес возврата по завершении ОП
* RSP - указатель стека, RFLAGS - флаговый регистр, оба - прерванного кода
* SS, CS - сегментные регистры, о них позже
* Error Code сохраняется, когда прерывания соответствуют ошибочным ситуациям. Содержит полезную информацию для дальнейшей обработки ошибки  
При этом надо озаботиться сохранением как минимум регистров общего назначения в теле ОП, чтобы программа, его вызвавшая, могла продолжить вычисления корректно.  
`iretq` - нструкция для завершения ОП. Она ожидает увидеть на стеке то, что туда было сохранено в момент вызова ОП, за исключением Error Code.
Его обязательно нужно удалить перед вызовом `iretq`.
## Таблица дескрипторов прерываний (IDT)  
IDT указывает, каким прерываниям какие обработчики соответствуют.  
IDTR - специальный регистр, хранящий ее адрес. Инструкции LIDT и SIDT позволяют записать/прочитать регистр IDT.  
Максимум 256 записей в IDT, то есть каждое ядро проца максимум хранит 256 прерываний, первые 32 из которых зарезервированы под специальные нужды. 
Оставшиеся используются для задания прерываний для внешних устройств.  

Когда драйвер устройства инициализирует его, он спрашивает у ОС какие есть свободные номера в IDT, сохраняет эту информацию в устройство, и когда что-то случается, 
устройство посылает специальное сообщение процессору, в котором указывает, какую запись в IDT использовать.  
Если устройство не может напрямую посылать сигналы процессору, оно, скорее всего, подключено к контроллеру прерываний, 
который отправляет процессору сообщения за него.  

**Контроллер прерываний** - посредник между устройством и процессором. Одна из его задач - обеспечение порядка обработки прерываний (если устройств несколько). 
Примеры для x86: PIC (Programmable Interrupt Controller) и APIC (Advanced PIC).  
## Запрет прерыаний  
Может понадобиться, например, если возникает во время инициализации какой-то структуры, к которой потом ОП захочет обратиться. 
Само собой, все прерывания запретить не получится (например ошибочные, если проц не знает, что делать дальше). Только прерывания от внешних устройств.  
Есть 3 варианта запрета:  
* Попросить устройство не генерировать их
* Отключить прерывания на контроллере прерываний
* Отключить прерывания на процессоре. Для x86 это делается через обнуление флага IF регистра RFLAGS путем инструкции `cli` (clear interrupt flag).
 Она очищает флаг, запрещяя прерывания. `sti` восстанавливает флаг (set ...).
