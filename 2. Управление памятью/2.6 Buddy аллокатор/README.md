# Buddy аллокатор  
Предназначен для аллокации больших участков памяти. Аллоцирует блоками, где каждый блок - 2^i последовательных страниц фиксированного размера. При этом важно заметить, 
что страницы paging и buddy не обязательно должны совпадать.  
Buddy аллокатор также не работает с памятью напрямую. Вместо страниц памяти будем использовать дескрипторы страниц, по которым легко восстанавливать 
соответствующие им страницы и наоборот.  
То есть, имеем массив дескрипторов. Такой подход пощволяет аллоцировать физическую память, что полезно, если какой-то кусок физической памяти не имеет своего 
логического отображения. Дескрипторы в целом не обязаны даже соответствовать какой-то памяти. Можем с помощью buddy аллоцировать место на диске, храня в памяти 
дескрипторы, за которыми закреплено место на диске.  
## Дескрипторы страниц  
***Какие поля будем хранить в дескрипторах?***  
+ Указатели, чтобы связать дескрипторы в двусвязный список
+ Признак свободности/занятости, распространяющийся на весь блок, а не только страницу, хранящую дескриптор
+ Указание на размер блока (уровень). Будем использовать показатель при степени 2 количества страниц  
## Конкретный пример  
Пусть изначально есть 2^N последовательных свободных страниц.
1) Заведем N+1 изначально пустой двусвязный список
2) i-ый список будет хранить свободные блоки размером 2^i страниц
3) Возьмем дескриптор 0-ой страницы и отметим как свободный
4) Зададим в нем уровень = N и добавим дескриптор в список с номером N

Хотим аллоцировать 2^i страниц:  
1) Найдем непустой список, хранящий свободные блоки больше или равные 2^i
2) Удаляем его из списка
3) Берем один из блоков и делим пополам, пока не останется 2^i. Одну половину при каждом делении возвращаем в соответствующий список.

Освобождение блока размером 2^i:  
1) Могли бы просто в i-ый список дескриптор записать, но это приведет к фрагментации
2) Проверяем вверх блоки, парные нашему по уровню, на занятость. Если свободны, то объединяем и поднимаемся тем самым на уровень выше. Так повторяем до победного. 
Также важно проверять, что оба блока имеют одинаковый размер (совпадают уровни дескрипторов).  
*NB Отсюда и название buddy (дружище) - парные блоки типо друзья, вот такой приколдес, просто топчик!*

***Как найти парный блок?***  
Допустим, освобождаем блок размера 2^i с номером j (номер первой страницы блока, т.е. позиция в массиве дескриптора первой страницы этого блока). 
Парный блок имеет номер j XOR 2^i.  

***Как может получиться, что в паре проверяемых блоков элементы разного уровня?***  
Такое может быть, если часть одного из блоков занята информацией. Тогда его дескриптор будет ссылаться лишь на свободную часть исходя из вышеописанного алгоритма.  

*NB закрепляющий: дескриптор - номер первой страницы в блоке, а не показатель степени*
